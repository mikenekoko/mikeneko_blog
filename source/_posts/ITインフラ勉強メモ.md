---
title: ITインフラ勉強メモ
date: 2020-05-25 18:08:03
tags:
---

#### IPアドレス(IPv4)
* ネットワーク上の機器を識別する為に割り当てられた住所
* 32bitで構成された8bitずつを10進数に変換されたものを「.」で区切って表記
* 各区切りでは0~255まで表記出来る
* 2^32通りのIPアドレス(約43億個)を保有することができるが、IPv4の枯渇問題に直面しており、IPv6への移行が進められている。
* つまり、現状からすると古い形式。

#### IPアドレス(IPv6)
* 128bitで構成された16bitずつを16進数に変換したものを「:」で区切って表記
* 2^128通りのIPアドレス(約340澗個)を保有することができるので、IPv4で見られるような枯渇問題を解決出来る。

#### プライベートIPアドレス
* LANや自ネットワーク内でのみ利用できるインターネットに接続をしないIPアドレス
* プライベートネットワーク内でのみ有効のため、世間的に使われているかどうかを気にせずIPを付与して問題ない。
* 以下のように利用できるIPアドレスの範囲は決められている。

|クラス|プライベートIPアドレスの範囲|概要|
|:--:|:--:|:--:|
|クラスA|10.0.0.0 〜 10.255.255.255|約1600万のIPアドレスの払い出しが可能|
|クラスB|172.16.0.0 〜 172.32.255.255|約100万件の払い出しが可能|
|クラスC|192.168.0.0 〜 192.168.255.255|約65,000件の払い出しが可能|

#### パブリック(グローバル)IPアドレス
* インターネット上で他の通信機器と通信を可能にする為のIPアドレス
* 他のIPアドレスと重複しない一意のIPアドレス

#### IPアドレスの範囲
* IPアドレスの範囲は「2のn乗個」で区切るという決まりがある。
* 4個、8個、16個、32個、64個、128個 .... 65536個
* 一般的な区切りは、256個と65536個

192.168.1.0 ~ 192.168.1.255
* CIDR表記： 192.168.1.0/24
* サブネットマスク表記：192.168.1.0/255.255.255.0

192.168.0.0 ~ 192.168.255.255
* CIDR表記：192.168.0.0/16
* サブネットマスク表記：192.168.0.0/255.255.0.0

CIDR表記
* ネットワークのビット長を「/ビット長」で表す表記。このビット長はPrefixと呼ばれる。
* こちらの方が一般的

サブネットマスク表記
* Prefixのビット数だけ2進数の1を並べ、残りを0で記述する表記
* 少し冗長的

#### ICANN(Internet Corporation for Assigned Names and Numbers)
* パブリックIPアドレスを一括管理している非営利団体
* 必要に応じて、配下の団体にIPアドレスを配布する形を取っている(以下画像)
* ICANNの配下には、地域別に管理する組織(RIR)、国別に管理する組織(NIR)、指定事業社(LIR)が存在し、IPアドレスを管理している。

IPアドレス(IPv4)の管理構造

|組織名|役割|具体的な組織例|
|:--:|:--:|:--:|
|ICANN|IPアドレス全体を管理|-|
|RIR|地域インターネットレジストリ|APNIC(アジア/太平洋)<br>ARIN(北アメリカ) ...etc|
|NIR|国別インターネットレジストリ|JPNIC(日本のIPアドレスを管理)|
|LIR|ローカルインターネットレジストリ|指定事業者|

この先にやっとエンドユーザに到達する

#### ルーティング
* TCP/IPではデータはパケット単位でやり取りが行われ、ルーターはそのパケット内に含まれる宛先IPアドレスを確認し、最も宛先のIPアドレスに近いネットワークへとパケットを転送する。
* その際にどのIPアドレスの時はどのネットワークに流すかを判断するのにルートテーブルを利用する。

#### パケット
* データを送る際には、パケット単位に分割されて送られる
* 分割されたパケットは宛先IPや送信先IPの情報を付与されることで、そのデータをどこに送るかを認識できる

#### ルーティングの流れ
<img width="719" alt="スクリーンショット 2020-07-13 18.40.41.png" src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/178351/f3c4f6e1-bf8b-6e0a-f879-dad551e73160.png">

ルーター1のルートテーブル

|ディスティネーション|ターゲット|
|:--:|:--:|:--:|
|network1|local|
|network2|local|
|network3|router2|
|network4|router2|

ルーター2のルートテーブル

|ディスティネーション|ターゲット|
|:--:|:--:|:--:|
|network1|router1|
|network2|router1|
|network3|local|
|network4|local|

1. ネットワーク1のサーバがIPアドレスBを持つサーバ4行きパケットをルーター1に送信
2. ルーター1はIPアドレスBがネットワーク4に含まれていることを確認し、ルートテーブルを参照して、ルーター2に対してパケットを送信する。
3. ルーター2はIPアドレスBがネットワーク4に含まれていることを確認し、ルートテーブルを参照して、ネットワーク4が接続されているインターフェースに転送する。

#### ルーティングプロトコル
* 各ルーターは自身に隣接するノードの情報を共有している。 ルーティングプロトコルはその情報を共有可能とし、各ルーターがより広範囲のネットワーク構成に関する情報を持てるようにする仕組み。
* このプロトコルのおかげで新たにネットワークが追加されても、自動的に各ルータに追加された情報が共有され、データのやりとりが可能になる。
* この仕組みは大きく分けて以下の2種類の仕組みから成り立っている。
  * EGP(Exterior Gateway Protocol)
    * インターネットサービスプロバイダーやAWSなどの規模の大きいネットワークはネットワークを管理する際にAS番号という番号を使って管理している。
    * このAS番号をやりとりして、どのネットワークの先にどのネットワークが接続されているかをやりとりする。
  * IGP(interior Gateway Protocol)
    * EGPの内部ルーター内でルートテーブルの情報をやり取りを行う。
    * 大まかな情報をEGPで共有し、IGPでより詳細な情報を共有している。

#### ポート
* 他のサーバとデータを送受信する為の出入り口。
* 0~65535のポートが用意されている。
* ポートがあるおかげで、1つのIPアドレスに対して複数のアプリケーションが同時に通信が出来る。
* 通信を行う際にはプロセス毎に設定されたポートを開いて通信を行う。

#### ウェルノウンポート
* 0~65535のポートのうち、0~1023までの各ポートはそれぞれ特定のサービスやプロトコルが利用することが認知されており、
* サーバ側ではこの決まりに基づいてポートが設定されている。
* ウェルノウンポートのプロセスを利用する際には、明示的にポート番号を指定しなくても、ポート番号を省略した場合は、ウェルノウンポートが利用される。
* ウェルノウンポートの一例

|ディスティネーション|ターゲット|
|:--:|:--:|:--:|
|20|ftp-data	ファイル転送(データ本体)|
|21|ftp	ファイル転送(コントロール)|
|22|ssh	リモートログイン(セキュア)|
|23|telnet	暗号化されていないテキスト通信|
|25|smtp	簡易メール転送|
|53|domain	DNS|
|80|http	ハイパーテキスト転送プロトコル|
|110|pop3	メール受信|
|123|NTP	時刻合わせ|
|143|imap	メール受信|
|443|https	ハイパーテキスト転送プロトコル(セキュア)|
|520|RIP	ルーティングプロトコル|

#### ファイアーウォール
* ネットワークへの不正アクセスをブロックする為のシステム。
* ファイアーウォールには複数種類が存在する。以下のパケットフィルタリングは代表的なもの。

#### パケットフィルタリング
* 送られてくるパケットのIPアドレスやポート番号その他情報から通信許可の可否を判断し、特定の通信をブロックすることが出来る。
* 10.0.1.1 のサーバーがあるとして、そこに 3306port での接続をブロックするなどが可能

#### ドメイン
* www.example.comといったドメイン名はピリオドで区切られた構造をしている
* それぞれ右側からトップレベルドメイン、第2レベルドメイン、第3レベルドメインと呼ばれる。
* ドメイン名空間を構成する全てのドメイン名は一意性が保証される。

#### ドメインの管理
* IPアドレスと同様にICANNが管理しており、トップレベルのドメイン名毎にレジストリと呼ばれる事業者が管理。

#### DNSサーバ
* ドメイン名でアクセスした際にIPアドレスに変換された後、対象サーバにアクセスを行うが、それを「名前解決」と呼ぶ
* DNSサーバは名前解決を行うが、世界中に分散したDNSサーバ群で構成されるデータベース。

DNSサーバによる名前解決のフロー
1. WEBブラウザに「http://example.com」と入力
2. 接続しているISPや会社組織内のDNSサーバに対して、www.example.co.jpのIPアドレスに紐づくIPアドレスの要求を行う
3. ルートサーバに対して、www.example.co.jpのIPアドレスに紐づくIPアドレスの要求を行う
4. ルートサーバからjpのDNSサーバに対して問い合わせするようレスポンスが返る
5. jpのDNSサーバに対して、www.example.co.jpのIPアドレスに紐づくIPアドレスの要求を行う
6. jpのDNSサーバから、co.jpのDNSサーバに対して問い合わせするようレスポンスが返る
7. co.jpのDNSサーバに対して、www.example.co.jpのIPアドレスに紐づくIPアドレスの要求を行う
8. co.jpのDNSサーバから、example.co.jpに対して問い合わせするようレスポンスが返る
9. example.co.jpに対して、www.example.co.jpのIPアドレスに紐づくIPアドレスの要求を行う
10. example.co.jpのDNSサーバから、www.example.co.jpに紐づくIPアドレスのレスポンスが返る

#### キャッシュDNSサーバと権威DNSサーバ
* キャッシュDNSサーバは、ドメインと紐づくIPアドレスの情報をキャッシュしているサーバで、クライアントからの問い合わせに対して、早いレスポンスが可能となる。
* キャッシュする時間は決められていて、保持期間が過ぎると、再度権威サーバに問い合わせを行う。
* 権威DNSサーバは、ドメインと紐づくIPアドレスを持っているサーバ。

#### HTTP(Hyper Text Transfer Protocol)
リクエスト
* リクエストライン
* 要求コマンドのこと。要求方法と要求するURLが含まれる。
* 例：「GET/ HTTP/1.1」

リクエストヘッダー
* ブラウザから送信される追加情報が含まれる
* 要求したいホスト名
* ブラウザの種類(ユーザエージェント)
* 対応言語
* Cookie情報
* Referer情報

リクエストボディ
* POSTメソッドを利用してHTMLフォームやAjaxでデータを送信する際に利用される。

レスポンス
* ステータスライン
* リクエストに対する成否を返したもの

|ステータスコード|内容|
|:--:|:--:|
|1xx系|処理中| 
|2xx系|成功した事を示す|
|3xx系|リダイレクトメッセージ|
|4xx系|クライアントエラーレスポンス|
|5xx系|サーバエラーレスポンス|

レスポンスヘッダー
* 追加情報を返す際に利用される

レスポンスボディ
* 要求されたURLに対するコンテンツを返す。HTMLのテキストや画像ファイルなど。
* これをメインに求めてみんなURL叩いてるよ

#### HTTPの各バージョンの違い

|バージョン|内容|
|:--:|:--:|
|HTTP1.0|1回のコネクションで1回のやり取りしか出来ないので、コンテンツの表示に時間が掛かる|
|HTTP1.1|1回のコネクションで複数回のやり取りが可能(Keep-Aliveの標準有効)になり、通信が高速化<br>複数回のやり取りは出来るものの、1つの処理が終わるまで次の処理が行えない。<br>TLSのサポートがされた事で、HTTPSを利用したセキュアな通信が可能になった。|
|HTTP2.0|複数のリクエストを同時に処理出来るようになり、HTTP1.1で抱えていた問題を解決<br>通信を行う際に、ヘッダー情報の圧縮を行う事で通信量を減らし高速化。<br>これまでヘッダー情報に様々な情報が追加されてくる中でデータ量が増加し、オーバーヘッドが発生。|
|HTTP3.0|QUICと呼ばれるUDPソケットを用いたプロトコルの上で動作する。<br>より早いハンドシェイクが行えるので、通信の確率に時間を掛けず、データ送信が可能<br>HPACK→QPACKと呼ばれるヘッダーの圧縮方式に変更<br>すべての通信をTLS1.3によって暗号化。|

#### OSI参照モデル
* OSI(国際標準化機構)が定めたコンピュータやネットワークシステムの概念を7階層で表現したもの
* OSI参照モデルが策定される以前は、各メーカーが独自の規格で製品を生産しており、メーカーが異なると通信が行えない状況であったが、異機種間での通信を可能にする為にOSIが策定された。
* TCP/IPモデルの普及によりOSI参照モデルはあくまで概念として残ることになった。

|階層|役割|
|:--:|:--:|
|アプリケーション層|アプリケーションレベルでのデータの通信手続きを規定|
|プレゼンテーション層|セッションにおけるデータの表現方法を規定|
|セッション層|通信元の機器上と通信したい機器上の両通信プログラム間での通信手順を定義|
|トランスポート層|通信元の機器と通信したい機器の間での通信ステータスを管理|
|ネットワーク層|通信したい機器(IPであれば宛先IPアドレス)への通信経路を決定|
|データリンク層|直接、もしくはレイヤー2 機器(L2 スイッチ等)を挟んで接続された機器間での通信方法を定|
|物理層|ケーブルの種類やコネクタの形状等の物理的な要件、伝送媒体(電気や光)での  bit 転送を行なう上でのノイズの基準値等を定義|

#### TCP/IP
* インターネットで標準的に利用されている通信プロトコル

4階層モデル
* OSI参照モデルに代わって普及したプロトコルで、現在はほとんどの製品がTCP/IPに準拠して作られている。

|階層|役割|代表プロトコル|
|:--:|:--:|:--:|
|アプリケーション層|アプリケーション間のやり取り|HTTP, SSH, DNS, SMTP|
|トランスポート層|データのやり取りの順番を制御したり、エラー訂正したりするなどの信頼性を高めたデータの転送を制御する|TCP, UDP|
|インターネット層|IPアドレスの割り当て、ルーティングをする|IP, ICMP, ARP|
|インターフェース層|ネットワーク上で接続されている機器同士で通信を行う|Ethernet, PPP|

#### TCP/IPに基づいた通信の流れ
例：「構築したwebサーバにローカル環境のwebブラウザから接続して、webページを表示する」

1. 名前解決のリクエスト(アプリケーション層)
  1. webブラウザ上からURLを叩いた際にDNSサーバに対して名前解決の処理の依頼を行う。
  1. その際にDNSプロトコルに基づいて、アプリケーション層で名前解決のリクエストを作成する。
2. UDPでカプセル化(トランスポート層)
  1. ①で作成したデータを送信するには、そのデータをトランスポート層に渡す必要がある。この際に①のデータがトランスポート層でカプセル化される。
  2. カプセル化のタイミングでUDPヘッダー(「送信元のポート番号」「宛先ポート番号」「データの長さ」「チェックサム(エラーがないか調べる)」)を追加する。
3. IPでカプセル化(インターネット層)
  1. ②で作成したデータをインターネット層で受け取り、IPヘッダー(「送信元IPアドレス」「宛先IPアドレス」「データ長」「生存時間」)を追加してカプセル化を行う
4. Ethernetでカプセル化(インターフェース層)
  1. ③のデータの段階でIPアドレスが付与されるので、実際に「LAN」「電話回線」に流す事が可能になる。この際にそれぞれの配線規格に準拠したヘッダーが付与される。
  2. 「LAN」を利用する場合は、「Ethernet」という規格になる為、データの先頭と末尾にEthernet用のデータが付与される。

#### udp/tcp
* TCP/IPで通信を行う場合、UDPとTCPという2種類の通信方法がある。

UDP
* UDPはステートレスプロトコルとも呼ばれ、状態を持たないプロトコル。
* TCPであれば、接続の確立を行なってから、通信を開始するが、UDPはそのようなことはせず、データは一方的に送りっぱなしとなる。
* 仮に通信先がデータを受け取れない状態にある場合、データはそのまま破棄される。
* 通信先へ正しくデータが送られたかどうかを確認をしないが、その分高速に通信を行うことが出来る。
* そういった特徴から、動画や音声をやり取りを行う際には、UDPが利用される。
* 安全性よりも速度を重視したプロトコル

TCPでの通信の特徴
* データのやり取りを行う際に、通信先に確実にデータが送られる仕組みをもつ。
* データを送信する前に、相手とデータのやり取りが出来るように、コネクションの確立を行う。これを3ウェイハンドシェイクと呼ぶ。
* 送るパケットにはデータの順序を示すシーケンス番号が割り当てられており、仮にデータが欠落した場合は、対象のシーケンス番号を再度要求することで、最終的なデータの欠損なくデータのやり取りを行うことが出来る。

#### 3ウェイハンドシェイクとデータの送信の流れ
1. 通信先に対する通信開始の合図を送信(クライアント→サーバ)
2. 1の合図の受領とクライアントへの通信の合図を送信(サーバ→クライアント)
3. 2に対する受領の送信(クライアント→サーバ)
4. データの送信(クライアント→サーバ)
5. データの送信(サーバ→クライアント)