---
title: scala秋祭り
date: 2019-09-16 12:47:40
tags:
---
一般参加者としてのメモ

# メモ
ハッシュタグ : `#ScalaAkiMatsuri`

# 14:00～14:30	「Scala における継続モナドの実装と活用」 
> 青山 直紀氏 ／ セプテーニ・オリジナル（質疑応答含む)
> セプの人 /  GANMA!とかの開発やってるよ

* 継続モナド : cats , scalazとかの事を話す

### Introduction 継続、継続私とは？

継続とは？ : その後に実行される計算 / 処理

```scala
計算処理
計算処理
表示処理
```

この流れだった場合、上から順番に処理される。それは、もう継続になっている。
こうした継続を明示的に書く事ができる。

```
add(1,2) { a =>
  mul(1, 3) { b =>
      show(b){ s =>
          println(s)
      }
    }
}
```

↑これはすでにモナド測

# 改めて、モナド継続とは？
モナド則をみたすように pure / cont を満たしたもの

### 継続モナドの実相
要するに、次の使われ方まで指定するもの。
糖衣構文のfor式の使われ方の先まで指定することで更に厳密な型の指定を実現する

### 継続モナドの文脈
Optionモナド　値の有無、失敗しるう可能性があるもの
List モナド 連立するモナド

継続モナド : 継続を値として扱える計算
↑の説明と同じ！

これによっていろんなことができる。

## 継続モナドの活用例
* 計算結果による分析
* エラーハンドリング
* リソースの管理
* タイムアウト
* リトライ


注意 : 継続モナドの先でエラーになった場合、メソッドが終了した場合でもそのメソッド内のエラー処理としてでてしまう。
-> 式の順序と継続モナドの流れは必ずしも一致しない。

* 様々な活用方法がある。
* for式の活用方法

上手に活用できるとシンプルに記述でき、可読性が向上する！
使われ方まで型指定して、名前を付与することで更に読みやすいコードを目指すことができる

### 感想
全く聞いたことのないもの。
確かに、糖衣構文でしか使われることを想定していないメソッドなどがたくさんあるのでそこに対しては改定ってもいいかもしれない！

-----

# 14:30～15:00	「From Tagless-Final to Typed-Final: Program Transformations in the Final Style」
> 鈴木健一氏 ／ ビズリーチ（質疑応答含む)

### Tagless-Final とは？
型安全な埋め込みDSLを構築する手法。



### Typed-Final とは？

### 感想
* 型合わせゲーム 
つまるところ、型の返還の処理の流れを定義している
この考え方は、Scalaもできるというだけで、別にScalaの機能ではない。 Ocamlとかでも使える。 = 今後他の言語をやっていくにあたって必要になる？
-> Kotlinでも使える？ここは調べてみる。もし、必要で、同じ考えを他の言語でも生かせるなら、この考えは今後もやっていかないとダメなのかもしれない

---

# 15:10～15:40	「広告配信システムでのトラフィック計測と実装方法」 
> 黒崎 優太氏 ／ サイバーエージェント（質疑応答含む)
> アドテク事業部 -> AI本部
> 敵

### 計測サーバの実相
* 計測の種類
* Akka Http を利用した計測サーバの実相

広告の計測は？
* imp
* click
* アクション（インストールした、ログインした、課金した～～～）
-> よくある計測判断基準。うちと同じ

AkkaHTTPに移行した

自分たちでも計測してるけど、広告主がやってる計測ツールもあるのでそこにリダイレクトさせる必要がある。
user -> ad -> clickサーバ -> 外部の計測ツール -> 200レスポンス -> リダイレクト みたいな

Featureと糖衣構文を返してる
糖衣構文の中だと全部eitherで書いてる
ユーザの情報をDynamoDBに持ってる -> うちのRedisと同じ

nettyを使うとリクエスト部分がノンブロッキングになる。ユーザのリクエストはそれぞれ独立しているので。

# 計測パラメータの引き回し
CAはクエリパラメータで引き回してる
-> 入札時のログさえあれば、そのログのIDから紐づければいいんじゃねってなるがデータ量が多すぎてしんどい。
-> インデックス貼ればいいんじゃないって思ったけど、データがとにかく多ければそれはそれでインデックス貼ること自体がコストになるかなぁ

毎日５TBくらいのデータが来るからさすがにその手法はダメ -> URLパラメータの手法に変えた

* パラメータ数が多い / URLが長い（クリックURLはどこも長いみたいだ）
* 暗号化処理がしんどい（パラメータごとにやってるとだるそう）
-> 内部パラメータは全て暗号化していた （あれのパラメータと同じだとと思う）
* URLパラメータ改案への耐性が下がる

上の問題は、
Protocol Buffersを利用して改善した！

これでバイナリとして受け取ることができる、それをクエリパラメーターに付与できるようにbase64でエンコードしたい。
ScalaPBの拡張を用いて、生成されるcase class/objectに自作のtraitを継承させて拡張させtあ。

可変長返還やURLパラメータ名分短くなる。
Deflateを採用した
動作が軽め。

リプレイ攻撃に対する対処法として、case classを用意してそこに対してなにも意味のない変数を用意する。
そこにランダムで値を生成し、そこを継続して処理を行うことで暗号化のパターンが毎回変わる。つまり、リプレイ攻撃が利かなくなるのだ。

### Amazon EMR を使った集計
EMR? -> Spark!

Apache Sparkで集計を実現する
広告主 x 日時の粒度でクリック数を確認する。
Scalaでかけちゃう

スケールする、テストコードが書ける
sparkのおかげで一部のワーカーが落ちても自動でリカバリする。集計は中断されない。 
=> うちの集計レポートのサーバーがいちいち落ちてるあの問題も全部これで解決するんじゃないか？

### 感想
GCPで類似したサービスが無いか調べてみよう。これがもしできれば、レポートサーバーをそのまま移行して集計レポートが詰まる問題が無くなるかも。

# 15:40～16:10	「サマーインターンシップ2019で学生とDDDなScala開発に取り組んだ」 
> 藤井 善隆氏 ／ チャットワーク（質疑応答含む）
> 事例的なお話をするよ

インターンシップで、DDDでScalaで開発したのでその話

### どんなことしたか？
* 講義を1週間
* 実際のコーディングを2週間

業務パートをこなすうえで必要な知識のみ伝える。
* インフラとかも含めてやってる
業務パートを過ごすうえで初めて聞く単語をなるべく減らす。
「これ知ってるからもうちょい調べたらなんとかなるかも！」みたいな状態に持っていく。進研ゼミ的な

* ソフトウェア開発の全体像
* 要件定義
* 設計
* 開発・テスト
* 配置
* 運尿
* インフラ
* チーム開発

とあるWebアプリケーションの開発業務をやる。Scrumをやる！
* 開発チーム : インターン生のみ。マジ？
* PO は社員、SMも社員。

これを2週間でやるのか・・・

* インターン生は、Scala経験なし。その他もろもろ
* 実践Scala入門をプレゼントした。Using Akka HTTPをやってもらうところもチュートリアルに加えた。

実際の講義内容
* 実践Scala入門と、業務で必要になる知識の間を埋めるような講義を行う。（Mapはこうで～～みたいな研修は行わないってことか）
* 実際に使うコードを解説

* あの本は、Scalaとはみたいな広い知識を知る部分の本なので、そこからの実践的なことを求める。
コードの読みやすさ、保守性、非機能要件とのとてーどおふ。

Scalaはいい意味でもいろいろな書き方ができてしまうので、要件定義とマッチしつつも読みやすいかどうかなどをチェックする
* チーム開発を意識したコードを目z巣。型石井、既存ライブラリを利用する、case classを利用する、タプルを利用する、traitoを利用する。。。
* 汎用的な方を特化した型にするための力をつけるなど

### 業務パート
ドメインモデリングを行う。
ユースケースを定義して、POと議論して、言葉の定義を定めてドメインモデルとしての枠組みを考え、そこをコードに落とし込んでレビューしてもらう。
基本的に、否定せずに「なんでその考えになったか」を書いてもらってそこに対して先輩社員が意見する。そこからインターン生が落としどころを決めてドメインモデルにする。

レビュアーが思い浮かんでいるモデル。

Message -> Bookmark -> UserAccount

ユースケースの説明。。。
BookMarkListを持つだけの型を定義するのはあり。複数形を持つための型はあり
-> 提案したい。。。

ユースケースを出すと、「ブックマークのリスト」が良く出てくる。なので、これはモデリングすべき。永続化の事はそこまで考えなくてもいい。
ユースケースにあるなら、それはモデリングすべきだ。

### 感想
教える立場に立つことが今後でてくると思うので参考になる。

------------

こっからLT

# 16:20～16:30	LT1 「面倒なことはScalaスクリプトにやらせよう」 ／ blac_k_ey
> Scalaスクリプトって何？
簡単なスクリプトを書きたいと思った時に、Scalaで書きたい！
でも、Scalaでやるといろんなファイルがめっちゃできるよね、

Ammoniteを使うとこれをスクリプトみたいにできるよ！
* REPL Script Runner

シンタックスハイライトもできる！？

sample.sc みたいなファイルを書いて、
```scala
println("はろわ")
```

amm sample.sc で走る。その場でコンパイルがh知って、実行される。
-> コンパイルいる時点でスクリプト言語で良くないか？
-> 2回目以降は、コンパイルしたキャッシュを用いるのでコンパイルをし直さない！
-> これは使えそう

本当にイメージはPerlみたいに書けるみたい！
じゃあ、amm コマンドさえ入っていればcrontabとかでも起動できるわけだ
今後のスクリプトはこれで書けたらいいね

APIを叩いて、それを取得して他のに送るというシステムをGitlabCIで行ってやっているみたい。
つまり、Rundeckとかを使ってやる必要が無くて、GitlabのSchedule機能を使って実装することもできるわけだ。
新規にコマンドを用意せず、gitlab-lunnerサーバーに起動する状況さえ作ってしまえばそのソースコードを起動できる。
-> 専用のサーバーを用意する必要がない！！
-> 今確か専用のコマンドラインを実行するサーバーを立てているのでそこのコストが消せることになる

# 16:30～16:40	LT2 「Dependency injection at AbemaTV」 ／ omarun_4263
> AbemaTVで使ってるDIツールを紹介するよ！

MinimalCake? -> 調べる
scaladiaの速度はNo1、実装もシンプル

AbemaTV意外での利用実績がないので、調べても何も出てこないよ
-> Qiitaとかで投稿したら注目浴びそう

DIツールこんなにあるんだ・・・

# 16:40～16:50	LT3 「SaaS企業をスケールするためにScalaを選択した理由と1年間の振り返り(仮)」 ／ showmant(takeo)
新規のスタートアップ（SaaS）をScalaで実装するのを決めたのとその経緯を発表。
サービスとしては、状態を管理するようなもの。

なんでScala？
-> 請求とか決済みたいな重いものを扱うので、堅朗性があるもの。Goと迷ったけどJavaやってたからScala
つまり、安心感のある言語としてやはりそういう認識がある。
最後の一押しは、問題が起きた時に自分が対応できる言語の方がいいからScalaを選んだらしい。
うちと一緒

* 開発スピード問題
Railsとかに比べるとどうしても遅いが、今回のニーズに合ってるのでScalaにした。
* 小さくリリースもできないし、適当にリリースもできない。一度インシデントを起こしたら、信憑性がない。Railsでとりあえず雑に作るのを否定するわけではないが、それが通じないサービスなので。

Scalaの採用って大変じゃない？人少ない？
スタートアップでは、設計だったりインフラだったり、調整だったりとかそっちが必要なのでそんなにScalaを重視しなかった。

余談のぶんぶん丸の話
CircleCIはめっちゃ金かかる。スタートアップの敵。なので、古いPCを専用のCIサーバーにして稼働させてめっちゃコスト抑えてますって話。
CircleCIってお金かかるのね。しかもホックして自前のサーバーでできるらしい。
うちはオンプレサーバー余りまくってるしやってもいいんじゃないかなぁ

# 16:50～17:00	LT4 「もう一つのビルドツール mill で Docker イメージを作る」 ／ atty303
ビルドツールの1つ、mill
SBTのライバル、人気的には4番目に位置する。

build.sbt みたいな感じで、 build.sc に書いていく。
速度は、sbtの2倍レベルで早い。2回目以降のビルドは、なんと10倍以上！！

sbt-nativeのdockerプラグインみたいに、dockerを作ってくれるモジュールはすでにある！（遅いらしいけど、そんなに気にしないからこれでいいかな）
共有サーバのCIを使ってるから、ビルド時間短くなるのは魅力的かなぁ
今使ってるツールの影響調査を調べないとダメだから気軽に提案は難しいなぁ

# 17:00～17:10	LT5 「sbtを開発の中で活用する方法・例について」／ k_bigwheel
sbtは難しい？
-> 難しい、できることが多くすべてを把握することが難しい。sbtでやれば一瞬のことを、shell script でやってたり。（sbt-nativeでdockerイメージ作れるのに、必死にスクリプト作ったりとかね）

メモ：IntelliJの右下に解析レベルを設定できるところがあって、ここを使うとフリーズを回避できたりするよ
-> 知らなかった。1回やってみたけど、implicitなどの追跡がちょっとおかしくなったので重くても使う方向で決めた。

sbt shellでテストの自動実行はいいよ。 
-> 調べてみる！！デグレ調査にもなるし

依存関係の定義を、sbtに指定させることができる！！
ドメイン層から、インフラ層を呼び出したり。ここを強制させてしまうことで、依存関係の逆転指摘は減るよね。
-> これ強制できるの！？すごい。

# 全体参加しての感想
とにかく、知らない事だらけでかなり刺激になった。
弊社で扱ってるScalaの世界は本当に序の口なんだなぁと思い知った！もっと頑張ろう。

こういった様々なツールを知っていくのはしんどいと思っていたけど、楽するためにこうしたものを学ぶという考え方を身に着けたので、苦じゃなくなった。どんどん知っていきたい。