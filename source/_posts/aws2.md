---
title: AWS勉強会2日目
date: 2020-07-03 16:32:06
tags:
---
# Amazon EKSとは？
ElasticKubernetesService（EKS）は、独自のKubernetesコントロールプレーンを立ち上げたり維持したりすること無く、AWSでKubernetesを簡単に実行できるようにするマネージド型サービス
EKSは多くのAWSサービスと統合されている
* コンテナイメージのECR
* 負荷分散のELB
* 認証のためのIAM
* 分離のためのVPC
これら全てがスケーラビリティとセキュリティを提供する

# リージョンとアベイラビリティゾーン（AZ）
リージョンは複数のアベイラビリティゾーンで構成（全世界で系76）
AZは複数のデータセンターによって構成され、高い対象外性を提供する
リージョンは地域ごとに分けられる
* もちろん日本にもあるよ！

そのなかにAZというデータセンターの区切りで分けられる
リージョン内のAZ同志であれば、高スループットかつ低レイテンシーのネットワーキングを提供することが可能

# クラウドセキュリティ
* クラウドセキュリティはAWSの最優先事項
* AWSクラウドの利点とは、使用したサービスに対してのみ料金が発生するため、事前の投資なしで必要なセキュリティを獲得できる

物理的なセキュリティは大丈夫？
* データセンターを持ち、公開されていない。また、Amazonの社員でも基本的には知られていない。
* 入場には厳密なチェックが必要

論理的セキュリティ
* ログイン履歴は全てロギングされ、監視されている
* 顧客側でキーペアを使用してアクセスする

データセキュリティ
* AWSはやむをえない場合を除き、顧客データを指定されたリージョンから通告なしに移動は絶対しない
* 客のデータが権限ない人々に流れないように、定期的に物理削除している

# IAM
* ユーザ/クレデンシャル管理
* アクセス権限管理
* 権限の委任と監査

IAMユーザー
* AWS操作用のユーザー。ユーザーごとに色々設定できる

IAMグループ
* IAMユーザーをまとめたグループ
* グループ単位で権限指定など可能

IAMで使用するクレデンシャル
* REST,Query形式のAPI利用時の認証に使用することが可能
* IAMユーザーごとに2つまで生成可能

IAMポリシー
* これは許可？拒否？
* それは何に対して？IP？S3のバケット？
* 細かく設定できる。「このIPだったら、S3のListBucketsとGet系の操作を許可する」など

アクセス可否の決定ロジック
* 全てのアクセスは、デフォルトで全て拒否
* ユーザのStatementがDenyでも、グループ単位でAllowならば許可になる

IAMロール
* AWSサービスやアプリケーションなど、エンティティに対してAWS操作権限を付与するための仕組み
* IAMユーザー/グループとは別

クラスター認証
* EKSでは、IAMとKubernetesRBAC（Role Based Access Control)が連携
* Kubectl経由で、EKSとIAMにおける認証作業を挟みながら作業ができる

VPC(VirtualPrivateCloud)
* AWS上にプライベートネットワークを構築
* あたかもデータセンターが複数あるような感じにできたりする！

例
* AWS全体のネットワーク空間をVPCとして定義（10.0.0.0/16）
* アベイラビリティゾーンを定義
* リソースが稼働する場所をサブネットとして定義（10.0.1.0/24）パブリックサブネット
* ゲートウェイ経由で外から接続できるようにする
* プライベートサブネット（10.0.2.0/24）として定義。こちらは外からアクセスできない。
* 上記の、VPC内にアベイラビリティゾーン->プライベートサブネット、パブリックサブネットという構築がVPC内にアベイラビリティゾーン経由でスケーリングできるようになる

ELB（ElasticLoadBalancing）とは
* ELBで実現できるシステム
* スケーラブルに複数のEC2インスタンスに負荷分散
* 高い可用性。正常なターゲットに割り振りが可能

ELB自体がスケーラブルである
* バックエンド側でサーバーがたくさん増えて、ELBが耐えきれなかったら意味がないのでELB自体もスケーリングできる

#### ELBの種類
ALB
* HTTP,HTTPS,HTTP/2
* VPC
* L7のコンテントベースのロードバランサー

NLB
* TCP,UDP,TLS
* VPC
* L4機能を提供するロードバランサー

CLB
* 旧世代のものなので現在推奨されない。

ELBどこにおくの？
* VPCの中。外からのアクセスを考えた場合に、LBにアクセスできればOKなのでLB自体はパブリックなサブネットIPに置けばいい
* そこから、プライベートなサブネットに振り分ければいい

ELBは負荷に応じて `自動で` スケールする
* ALB/CLBにおいては接続リクエストが瞬間的に急増したりして、ELBのスケーリングが間に合わない場合はHTTP503を返す
* 回避方法は事前にALB/CLBをスケールさせておく
* NLBは暖気扶養で突発的な数百万リクエスト/秒のトラフィックも捌ける <- すごい

ALB Ingress Controller
* kubernetes.io/ingress.class: alb 注釈を付けて Ingress リソースがクラスターで作成されるたびに、Application Load Balancer (ALB) および必要な 

AWS サポートリソースの作成をトリガーするコントローラー
* Kubernetes の Service を作成すると、 AWS の Classic Load Balancer が作成されます。 Classic Load Balancer 以外に Application Load Balancer を利用したい場合、ALB Ingress Controllerを利用することでALBが使えるようになる

ECRコンテナイメージの脆弱性スキャン
* 入れたソフトウェアの脆弱性がないかイメージをスキャンしてくれる
* オープンソースの CoreOS Clairproject を理容師た脆弱性の性的スキャン
* 費用は無料！
* pushされたら、スキャンが走る
* 動的スキャンもあり、ランタイム環境で実行されるスキャン。既に実行されているコンテナの脆弱性を特定することが可能
* ECRの性的スキャンでは、スキャン後に発見された脆弱性に対応するために定期スキャンの実施を推奨している

eksctl
* 各種設定必要なIAMRole,VPC,Subnetや設定を含めて一括設定してくれる！
* 実態はCloudCormationを利用
* AWSのサポート対象です

Amazon VPC CNI plugin for Kubernetes
* Kubernetes内だけのVPC
* CNIという単位で、その中にNginxのPodとかScalaのPodとかを立てる
* GKEでいう、Pod -> CNI, Pod -> Container かな？

Spot Instans
* AWSで余っているリソースを使ってインスタンスを立ち上げることができる
* また、AWSがリソース使いたい場合に中断されることがある。その場合、2分前に通知がくる
* またはリクエストした価格（上限価格）をスポットインスタンス価格が上まったとき
* なんと90%OFFで使うことができる！！

クラスターエンドポイントのアクセスコントロール
* パブリックから元々アクセスできるが、パブリックアクセスの無効を推奨。設定可能
* プライベート専用クラスターエンドポイントへのアクセス
  * アクセスはクラスターのVPCまたは接続されたネットワーク内

AWS Fargate Profile
* セレクタに一致したPodがFargateにスケジュールされる。
* 複数セレクタがある場合は、いずれかにマッチすればFargateにスケジュールされる
* 複数のProfileにマッチした場合、どれが適応されるかはランダム

Fargateのログ
* マネージドサービスのため中に入ってログを見るなどは不可能
* ログは履いているので、CloudWatchに流して見ることは可能

アプリケーションログ
* ログコレクタを利用して取得
* オープンソースのFluentdなどで送信可能

CloudWatchContainerInsights
* CloudWatchの1機能。タスクやコンテナレベルでメトリクスやログを取得することが可能
* 自動的にダッシュボードを作成可能

# Liveness prove, Readiness prove
Livenss Probe
* ダメになったら転生させる

Readiness Probe
* ダメになったら知らせる

config
* livenessProbe: livenessProveを使うよという宣言
* readinessProbe: Readinessproveを使うよという宣言
* initialDelaySeconds: 〜〜秒待ってから
* periodSeconds: 活性proveのチェック感覚。 5にしたら、5秒毎にやる